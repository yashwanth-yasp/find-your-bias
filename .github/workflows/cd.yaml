name: Simple CD after CI with DAST

on:
  push:
    branches:
      - '**'
  workflow_run:
    workflows: ["Microservices CI"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    

    steps:
      # - name: Checkout code
      #   uses: actions/checkout@v4
      #   with:
      #     repository: ${{ github.event.workflow_run.head_repository.full_name }}
      #     ref: ${{ github.event.workflow_run.head_sha }}

      - name: Log workflow conclusion
        run: echo "The triggering workflow's conclusion was ${{ github.event.workflow_run.conclusion }}"

      - name: Checkout code
        uses: actions/checkout@v4

      # - name: Setup Python
      #   uses: actions/setup-python@v5
      #   with:
      #     python-version: '3.9'


      # Configure kubeconfig from secret
      - name: Set up Kubeconfig
        run: |
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 --decode > $HOME/.kube/config

      - name: Create/Update AWS Credentials Secret in K8s
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          kubectl delete secret aws-credentials --ignore-not-found
          kubectl create secret generic aws-credentials \
            --from-literal=AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \
            --from-literal=AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY

      - name: Deploy all microservices
        run: |
          echo "➡️ Updating Vote Service mm"
          kubectl set image deployment/vote vote=${{ secrets.DOCKER_HUB_USERNAME }}/vote-find-your-bias:${{ github.event.workflow_run.head_sha }}
          kubectl rollout status deployment/vote

          echo "➡️ Updating Result Service"
          kubectl set image deployment/result result=${{ secrets.DOCKER_HUB_USERNAME }}/result-find-your-bias:${{ github.event.workflow_run.head_sha }}
          kubectl rollout status deployment/result

          echo "➡️ Updating Worker Service"
          kubectl set image deployment/worker worker=${{ secrets.DOCKER_HUB_USERNAME }}/worker-find-your-bias:${{ github.event.workflow_run.head_sha }}
          kubectl rollout status deployment/worker

          echo "➡️ Updating AI Analyzer Service"
          kubectl set image deployment/ai-analyzer ai-analyzer=${{ secrets.DOCKER_HUB_USERNAME }}/ai-analyzer-find-your-bias:${{ github.event.workflow_run.head_sha }}
          kubectl rollout status deployment/ai-analyzer

      # --- In-Cluster DAST Stage ---
      - name: Run OWASP ZAP inside Kubernetes
        run: |
          echo "Starting OWASP ZAP scan against vote service..."
          
          # Create a temp ZAP scan pod
          kubectl run zap-scan \
            --image=owasp/zap2docker-stable \ 
            --restart=Never \
            --command -- \
            zap-baseline.py \
            -t http://vote:80 \
            -r /tmp/zap_report.html \
            -m 5

          # Wait for the pod to complete
          echo "Waiting for ZAP scan to complete..."
          timeout=300
          while [[ $(kubectl get pod zap-scan -o 'jsonpath={.status.phase}') != "Succeeded" && $timeout -gt 0 ]]; do
            phase=$(kubectl get pod zap-scan -o 'jsonpath={.status.phase}')
            if [[ $phase == "Failed" ]]; then
              echo "ZAP scan pod failed!"
              kubectl logs zap-scan
              kubectl delete pod zap-scan
              exit 1
            fi
            sleep 10
            timeout=$((timeout-10))
          done

          if [[ $timeout -le 0 ]]; then
            echo "ZAP scan timed out."
            kubectl logs zap-scan
            kubectl delete pod zap-scan
            exit 1
          fi

          echo "ZAP scan completed. Copying report..."
          # Copy the report from pod to local
          kubectl cp zap-scan:/tmp/zap_report.html ./zap_report.html

          # Cleanup the pod
          echo "Cleaning up ZAP scan pod..."
          kubectl delete pod zap-scan

      - name: Upload DAST Report
        uses: actions/upload-artifact@v4
        with:
          name: dast-report
          path: zap_report.html

